{{ template "_header.html" . }}

<article>
    {{ if .Part.ImagePath.Valid }}
    <img src="/uploads/{{.Part.ImagePath.String}}" alt="{{.Part.Name}} image" style="max-height: 200px; width: auto;">
    {{ end }}
    <hgroup>
        <h2>{{ .Part.Name }}</h2>
        <p>{{ .Part.Description.String }}</p>
    </hgroup>
    <div class="grid">
        <div>
            <strong>Part Number:</strong> {{ .Part.PartNumber.String }}<br>
            <strong>Manufacturer:</strong> {{ .Part.Manufacturer.String }}<br>
            <strong>Supplier:</strong> {{ .Part.Supplier.String }}
        </div>
        <div>
            <strong>Status:</strong> {{ .Part.Status.String }}<br>
            <strong>Unit Cost:</strong> ${{ printf "%.2f" .Part.UnitCost.Float64 }}<br>
            <strong>Total Quantity:</strong> {{ .Part.TotalQuantity }}
        </div>
        <div>
            <strong>Stock Tracking:</strong>
            {{ if .Part.StockTracking }}
            Enabled <br>
            <strong>Min Stock (Red):</strong> {{ .Part.MinStock }}<br>
            <strong>Reorder (Yellow):</strong> {{ .Part.ReorderPoint }}
            {{ else }}
            Disabled
            {{ end }}
        </div>
    </div>

    <details>
        <summary role="button" class="secondary outline">Edit Part Properties</summary>
        <article>
            <form action="/part/{{.Part.ID}}/details" method="POST">
                <div class="grid">
                    <label for="name">
                        Part Name
                        <input type="text" id="name" name="name" value="{{.Part.Name}}" required>
                    </label>
                    <label for="part_number">
                        Part Number
                        <input type="text" id="part_number" name="part_number" value="{{.Part.PartNumber.String}}">
                    </label>
                    <label for="manufacturer">
                        Manufacturer
                        <input type="text" id="manufacturer" name="manufacturer" value="{{.Part.Manufacturer.String}}">
                    </label>
                    <label for="supplier">
                        Supplier
                        <input type="text" id="supplier" name="supplier" value="{{.Part.Supplier.String}}">
                    </label>
                </div>

                <div class="grid">
                    <label for="description">
                        Description
                        <textarea id="description" name="description">{{.Part.Description.String}}</textarea>
                    </label>
                    <label for="status">
                        Status
                        <select id="status" name="status">
                            <option value="active" {{if eq .Part.Status.String "active" }}selected{{end}}>Active
                            </option>
                            <option value="obsolete" {{if eq .Part.Status.String "obsolete" }}selected{{end}}>Obsolete
                            </option>
                            <option value="in-progress" {{if eq .Part.Status.String "in-progress" }}selected{{end}}>
                                In-Progress</option>
                        </select>
                    </label>
                </div>

                <div class="grid">
                    <label for="unit_cost">
                        Unit Cost
                        <input type="number" id="unit_cost" name="unit_cost" step="0.01"
                            value="{{.Part.UnitCost.Float64}}">
                    </label>
                    <label for="min_stock">
                        Min Stock (Red)
                        <input type="number" id="min_stock" name="min_stock" value="{{.Part.MinStock}}">
                    </label>
                    <label for="reorder_point">
                        Reorder (Yellow)
                        <input type="number" id="reorder_point" name="reorder_point" value="{{.Part.ReorderPoint}}">
                    </label>
                    <label for="stock_tracking_enabled">
                        Enable Stock Tracking
                        <input type="checkbox" id="stock_tracking_enabled" name="stock_tracking_enabled" role="switch"
                            {{if .Part.StockTracking}}checked{{end}}>
                    </label>
                </div>

                <button type="submit">Save Changes</button>
            </form>
        </article>
    </details>
</article>

<article>
    <h4>Manage Categories (Tags)</h4>

    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
        {{ range .AssignedCategories }}
        <span id="part-cat-{{.ID}}"
            style="background-color: var(--pico-secondary-background); padding: 0.25rem 0.75rem; border-radius: var(--pico-border-radius); display: flex; align-items: center; gap: 0.5rem;">
            {{ .Name }}
            <button style="padding: 0; line-height: 1; width: 1.25rem; height: 1.25rem; font-size: 0.75rem;"
                class="secondary outline" hx-delete="/part/{{$.Part.ID}}/categories/{{.ID}}" hx-target="closest span"
                hx-swap="outerHTML" hx-confirm="Are you sure you want to remove the '{{.Name}}' category?">
                &times;
            </button>
        </span>
        {{ else }}
        <p style="margin-bottom: 0;">No categories assigned.</p>
        {{ end }}
    </div>

    <hr>

    <form action="/part/categories" method="POST">
        <input type="hidden" name="part_id" value="{{.Part.ID}}">
        <div class="grid">
            <label for="category_name">
                Add Category
                <input type="text" id="category_name" name="category_name" placeholder="Type a new or existing category"
                    required list="category-list">
                <datalist id="category-list">
                    {{ range .AllCategories }}
                    <option value="{{.Name}}">
                        {{ end }}
                </datalist>
            </label>
            <button type="submit" style="margin-top: 1.5rem;">Add</button>
        </div>
    </form>
</article>

<article>
    <h4>Upload Image</h4>
    <form action="/part/{{.Part.ID}}/image/upload" method="POST" enctype="multipart/form-data">
        <label for="part_image">
            Part Image (Max 5MB)
            <input type="file" id="part_image" name="part_image" accept="image/*" required>
        </label>
        <button type="submit">Upload</button>
    </form>
</article>

<article>
    <h4>Manage URLs</h4>
    <p>Add datasheets, supplier links, or guides.</p>

    <table>
        <tbody>
            {{ range .URLs }}
            <tr id="url-{{.ID}}">
                <td>
                    <a href="{{.URL}}" target="_blank" rel="noopener noreferrer">
                        {{ or .Description.String .URL }}
                    </a>
                </td>
                <td style="width: 1%;">
                    <button class="secondary" hx-delete="/part/urls/{{.ID}}" hx-target="closest tr" hx-swap="outerHTML"
                        hx-confirm="Are you sure you want to delete this URL?">
                        Delete
                    </button>
                </td>
            </tr>
            {{ else }}
            <tr>
                <td colspan="2" style="text-align: center;">No URLs added for this part.</td>
            </tr>
            {{ end }}
        </tbody>
    </table>

    <hr>

    <form action="/part/urls" method="POST">
        <input type="hidden" name="part_id" value="{{.Part.ID}}">
        <div class="grid">
            <label for="url">
                URL
                <input type="url" id="url" name="url" placeholder="https://www.example.com" required>
            </label>
            <label for="description">
                Description (optional)
                <input type="text" id="description" name="description" placeholder="e.g., Datasheet">
            </label>
        </div>
        <button type="submit">Add URL</button>
    </form>
</article>

<article>
    <h4>Manage Documents</h4>
    <p>Upload datasheets, manuals, or other local files (Max 5MB).</p>

    <table>
        <tbody>
            {{ range .Documents }}
            <tr id="doc-{{.ID}}">
                <td>
                    <strong>{{ or .Description.String .Filename }}</strong>
                    <br>
                    <small>{{ .Filename }}</small>
                </td>
                <td style="width: 1%; white-space: nowrap;">
                    <a href="/part/document/{{.ID}}" role="button" class="secondary outline">
                        Download
                    </a>
                    <button class="secondary" hx-delete="/part/document/{{.ID}}" hx-target="closest tr"
                        hx-swap="outerHTML" hx-confirm="Are you sure you want to delete '{{.Filename}}'?">
                        Delete
                    </button>
                </td>
            </tr>
            {{ else }}
            <tr>
                <td colspan="2" style="text-align: center;">No documents uploaded for this part.</td>
            </tr>
            {{ end }}
        </tbody>
    </table>

    <hr>

    <form action="/part/{{.Part.ID}}/document/upload" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="part_id" value="{{.Part.ID}}">
        <div class="grid">
            <label for="part_document">
                File
                <input type="file" id="part_document" name="part_document" required>
            </label>
            <label for="doc_description">
                Description (optional)
                <input type="text" id="doc_description" name="description" placeholder="e.g., Full Datasheet">
            </label>
        </div>
        <button type="submit">Upload Document</button>
    </form>
</article>

<article>
    <h3>Inventory Locations</h3>
    <div id="locations-table-wrapper">
        {{ template "_part-locations-list.html" .Locations }}
    </div>
    <hr>
    <h4>Add to New Bin</h4>
    <form action="/part/locations" method="POST">
        <input type="hidden" name="part_id" value="{{.Part.ID}}">

        <div class="grid">
            <label for="bin_id">
                Bin
                <select id="bin_id" name="bin_id" required>
                    <option value="" disabled selected>Select an available bin...</option>
                    {{ range .AvailableBins }}
                    <option value="{{.ID}}">{{.Name}} (Seg: {{.WLEDSegmentID}}, LED: {{.LEDIndex}})</option>
                    {{ end }}
                </select>
            </label>

            <label for="quantity">
                Quantity
                <input type="number" id="quantity" name="quantity" value="1" min="0" required>
            </label>
        </div>
        <button type="submit">Add Stock</button>
    </form>
</article>

{{ template "_footer.html" . }}